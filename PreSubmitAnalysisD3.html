<!DOCTYPE html>
<html>
<head>
    <title>Vertical Bar Chart with D3.js</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .bar-label {
            font-size: 14px;
            text-anchor: middle;
        }
        .tooltip {
            position: absolute;
            background-color: white;
            padding: 5px;
            border: 1px solid black;
            border-radius: 5px;
            pointer-events: none;  // to prevent the tooltip itself from triggering mouse events
        }
        .file-label {
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<script>
    window.onload = function() {
        var jsonFiles = ["./data/presubmit_jobs_ovn.json", "./data/presubmit_jobs_cno.json"];

        var dataPromises = jsonFiles.map(file => d3.json(file));
        Promise.all(dataPromises).then(allData => {
            // Find the maximum number of data points across all datasets
            var maxDataPoints = Math.max(...allData.map(data => Math.max(data.filter(job => job.AlwaysRun && !job.Optional).length, data.filter(job => job.Optional).length)));

            // Iterate over the data to create the charts
            allData.forEach((data, index) => {
                var requiredJobs = data.filter(job => job.AlwaysRun && !job.Optional);
                var optionalJobs = data.filter(job => job.Optional);
                var projectName = jsonFiles[index].match(/presubmit_jobs_(\w+)\.json/)[1].toUpperCase();

                // Pad the datasets with empty data points
                while (requiredJobs.length < maxDataPoints) {
                    requiredJobs.push({Name: "", PassRate: 0, AlwaysRun: true, Optional: false});
                }
                while (optionalJobs.length < maxDataPoints) {
                    optionalJobs.push({Name: "", PassRate: 0, AlwaysRun: false, Optional: true});
                }

                requiredJobs.sort((a, b) => b.PassRate - a.PassRate);
                optionalJobs.sort((a, b) => b.PassRate - a.PassRate);

                var chartId1 = "myChart" + (index * 2 + 1);
                var chartId2 = "myChart" + (index * 2 + 2);
                var tooltipId1 = "tooltip" + (index * 2 + 1);
                var tooltipId2 = "tooltip" + (index * 2 + 2);
                var labelId = "label" + index;

                var svg1 = d3.select("body").append("svg").attr("id", chartId1);
                var svg2 = d3.select("body").append("svg").attr("id", chartId2);

                var tooltip1 = d3.select("body").append("div").attr("id", tooltipId1).attr("class", "tooltip").style("opacity", 0);
                var tooltip2 = d3.select("body").append("div").attr("id", tooltipId2).attr("class", "tooltip").style("opacity", 0);

                // Create the charts
                createChart(requiredJobs, chartId1, tooltipId1, 500, maxDataPoints, projectName + " - Required");
                createChart(optionalJobs, chartId2, tooltipId2, 500, maxDataPoints, projectName + " - Optional");
            });
        });
    }

    function createChart(jobs, chartId, tooltipId, chartHeight, maxDataPoints, title) {
        // Calculate the width of the bars and the SVG based on the maximum number of bars
        var margin = {top: 20, right: 20, bottom: 300, left: 40},
            barWidth = 20,
            barSpace = 15,
            width = maxDataPoints * (barWidth + barSpace) * 2,
            height = chartHeight;

        var x = d3.scaleBand()
            .range([0, width])
            .paddingInner(barSpace / (barWidth + barSpace))
            .paddingOuter(0)
            .domain(d3.range(maxDataPoints));

        var x = d3.scaleBand()
            .range([0, width])
            .padding(0.1)
            .domain(jobs);

        var barData = jobs.map(job => ({
            jobName: job.Name,
            passRate: job.PassRate
        }));

        var jobNames = jobs.map(job => job.Name);
        var passRates = jobs.map(job => job.PassRate);

        var x = d3.scaleBand()
            .range([0, width])
            .padding(0.1)
            .domain(jobNames);

        var y = d3.scaleLinear()
            .range([height, 0])
            .domain([0, 1]);  // The domain is [0, 1] since the pass rates are percentages

        var svg = d3.select("#" + chartId)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Define gradient
        var defs = svg.append("defs");
        var gradient = defs.append("linearGradient")
            .attr("id", "svgGradient" + chartId) // Making the gradient ID unique for each chart
            .attr("x1", "0%")
            .attr("x2", "0%")
            .attr("y1", "100%")
            .attr("y2", "0%");

        gradient.append("stop")
            .attr('class', 'start')
            .attr("offset", "0%")
            .attr("stop-color", "green")
            .attr("stop-opacity", 1);

        gradient.append("stop")
            .attr('class', 'end')
            .attr("offset", "100%")
            .attr("stop-color", "red")
            .attr("stop-opacity", 1);

        svg.selectAll(".bar")
            .data(barData)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d, i) { return i * (barWidth + barSpace); })
            .attr("width", barWidth)
            .attr("y", function(d) { return y(d.passRate); })
            .attr("height", function(d) { return height - y(d.passRate); })
            .style("fill", "url(#svgGradient" + chartId + ")")
            .on("mouseover", function(event, d) {
                svg.append("text")
                    .attr("id", tooltipId)
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("font-family", "Comic Sans MS")
                    .attr("font-size", "30px")
                    .attr("fill", "black")
                    .text(d.jobName);
            })
            .on("mouseout", function(d) {
                svg.select("#" + tooltipId).remove();
            });

        var yAxis = d3.axisLeft(y).tickFormat(d3.format(".0%"));
        svg.append("g").call(yAxis);

        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 + (margin.top))
            .attr("text-anchor", "middle")
            .style("font-size", "50px")
            .style("font-weight", "bold")
            .text(title);


        svg.selectAll(".bar-label")
            .data(barData)
            .enter()
            .append("text")
            .text(function(d) { return d.jobName ? (d.passRate * 100).toFixed(0) + '%' : ''; }) // Only display the label if jobName is not empty
            .attr("class", "bar-label")
            .attr("x", function(d, i) { return i * (barWidth + barSpace) + barWidth / 2; }) // Align the labels with the bars
            .attr("y", function(d) { return y(d.passRate) - 5; });

    }
</script>
</body>
</html>
